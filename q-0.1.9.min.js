(function(e,j){function p(a){return a}function q(){var a=[],b,c=m(i.prototype);c.emit=function(){var d=Array.prototype.slice.call(arguments);a?a.push(d):n.apply(j,[b].concat(d))};c.valueOf=function(){if(a)return c;return b.valueOf()};var f=function(d){var h;if(a){b=k(d);d=0;for(h=a.length;d<h;++d)n.apply(j,[b].concat(a[d]));a=j}};return{promise:r(c),resolve:f,reject:function(d){f(g(d))}}}function i(a,b,c){if(b===j)b=function(d){return g("Promise does not support operation: "+d)};var f=m(i.prototype);
f.emit=function(d,h){h=h||p;var s=Array.prototype.slice.call(arguments,2);s=a[d]?a[d].apply(a,s):b.apply(a,arguments);return h(s)};if(c)f.valueOf=c;return r(f)}function t(a){return a instanceof i}function u(a){if(a===j||a===null)return true;return!v(a)&&!t(a.valueOf())}function v(a){if(a===j||a===null)return false;return a.valueOf()instanceof g}function g(a){return i({when:function(b){return b?b(a):g(a)}},function(b,c){var f=g(a);return c?c(f):f},function(){var b=m(g.prototype);b.reason=a;return b})}
function k(a){if(t(a))return a;return i({when:function(){return a},get:function(b){return a[b]},put:function(b,c){a[b]=c},"delete":function(b){delete a[b]},post:function(b,c){return a[b].apply(a,c)}},j,function(){return a})}function w(a,b,c){var f=q(),d=false;n(k(a),"when",function(h){if(!d){d=true;f.resolve(k(h).emit("when",b,c))}},function(h){if(!d){d=true;f.resolve(c?c(h):g(h))}});return f.promise}function l(a){return function(b){var c=q(),f=Array.prototype.slice.call(arguments,1);n.apply(j,[k(b),
a,c.resolve].concat(f));return c.promise}}function n(a){var b=Array.prototype.slice.call(arguments,1);o(function(){try{a.emit.apply(a,b)}catch(c){x(c.stack||c)}})}var o;try{o=require("event-queue").enqueue}catch(y){o=function(a){setTimeout(a,0)}}var x;x=typeof console!=="undefined"?function(a){console.log(a)}:typeof require!=="undefined"?require("system").print:function(){};var r=Object.freeze||p,m=Object.create||function(a){var b=function(){};b.prototype=a;return new b};e.enqueue=o;e.defer=q;e.Promise=
i;i.prototype.toSource=function(){return this.toString()};i.prototype.toString=function(){return"[object Promise]"};r(i.prototype);e.isPromise=t;e.isResolved=u;e.isRejected=v;e.reject=g;g.prototype=m(i.prototype);g.prototype.constructor=g;e.ref=k;e.when=w;e.asap=function(a,b,c){b=b||p;return u(a)?b(a.valueOf()).valueOf():w(a,b,c)};e.Method=l;e.get=l("get");e.put=l("put");e.del=l("del");e.post=l("post");e.defined=function(a){return e.when(a,function(b){if(b===j||b===null)return g("Resolved undefined value: "+
b);return b})};e.error=function(a){a instanceof Error||(a=Error(a));throw a;}})(typeof exports!=="undefined"?exports:this["/q"]={});